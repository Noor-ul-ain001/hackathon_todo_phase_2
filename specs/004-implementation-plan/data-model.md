# Data Model Design

**Date**: 2025-12-23
**Feature**: Phase I Unified Todo Application
**Purpose**: Define data structures and relationships for Phase I

---

## Overview

Phase I has a single core entity: **Task**. This entity represents a to-do item with four fields as specified in the constitution and spec 002.

**Design Principles**:
- Simple, flat structure (no relationships)
- Strong validation at creation/update
- Immutable ID after creation
- Type-safe with Python type hints
- Constitution-compliant (Phase I fields only)

---

## Entity: Task

### Description

Represents a single to-do item in the task management system.

### Fields

| Field | Type | Required | Default | Mutable | Validation |
|-------|------|----------|---------|---------|------------|
| id | int | Yes | Auto-generated | No | Positive integer (>= 1), unique |
| title | str | Yes | User-provided | Yes | Non-empty, non-whitespace-only |
| description | str | No | "" | Yes | None ‚Üí "", all chars preserved |
| completed | bool | Yes | False | Yes | Strict boolean (true/false) |

### Field Details

#### id (int)
- **Purpose**: Unique identifier for task
- **Generation**: Auto-generated by `IDGenerator` service
- **Range**: Positive integers starting from 1
- **Uniqueness**: Guaranteed unique across all tasks (including deleted)
- **Immutability**: Cannot be changed after task creation
- **Reuse**: IDs are never reused (counter only increments)

#### title (str)
- **Purpose**: Task name/summary
- **Constraints**:
  - Cannot be empty string ("")
  - Cannot be whitespace-only ("   ", "\t", "\n")
  - Must be actual string type (no None)
- **Normalization**: Trim leading/trailing whitespace, collapse multiple spaces to single
- **Length**: Soft limit 200 characters (UI layer may warn/truncate display)
- **Characters**: All characters preserved (quotes, unicode, emojis, special chars)

#### description (str)
- **Purpose**: Optional detailed information about the task
- **Constraints**:
  - Must be string type
  - Empty string allowed
  - None converted to "" automatically
- **Length**: Soft limit 1000 characters (UI layer may warn/truncate display)
- **Characters**: All characters preserved including newlines, quotes, unicode

#### completed (bool)
- **Purpose**: Track task completion status
- **Type**: Strict boolean (True/False)
- **Coercion**: NO truthiness coercion (1, "true", etc. rejected)
- **Default**: False for new tasks
- **Toggle**: Can be changed between True and False

---

## Data Model Specification

### Python Implementation

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class Task:
    """
    Represents a single to-do item.

    Attributes:
        id: Unique positive integer identifier (auto-generated, immutable)
        title: Required non-empty string task name
        description: Optional string with task details (defaults to "")
        completed: Boolean completion status (defaults to False)

    Raises:
        ValidationError: If any field validation fails

    Example:
        task = Task(id=1, title="Buy groceries", description="Milk, eggs", completed=False)
    """
    id: int
    title: str
    description: str = ""
    completed: bool = False

    def __post_init__(self):
        """
        Validate all fields after dataclass initialization.

        This method is called automatically by the dataclass after __init__.
        It ensures all constraints are satisfied before the Task instance is used.
        """
        self._validate_id()
        self._validate_title()
        self._validate_description()
        self._validate_completed()

    def _validate_id(self) -> None:
        """Validate ID is positive integer."""
        if not isinstance(self.id, int):
            raise ValidationError("ID must be a positive integer")
        if self.id < 1:
            raise ValidationError("ID must be a positive integer")

    def _validate_title(self) -> None:
        """Validate title is non-empty string."""
        if not isinstance(self.title, str):
            raise ValidationError("Title must be a string")
        if not self.title or self.title.isspace():
            raise ValidationError("Title is required and cannot be empty")

        # Normalize: trim and collapse multiple spaces
        self.title = " ".join(self.title.split())

    def _validate_description(self) -> None:
        """Validate description is string, convert None to empty."""
        if self.description is None:
            self.description = ""
        if not isinstance(self.description, str):
            raise ValidationError("Description must be a string")

    def _validate_completed(self) -> None:
        """Validate completed is strict boolean."""
        if not isinstance(self.completed, bool):
            raise ValidationError("Completed status must be a boolean (true or false)")


class ValidationError(Exception):
    """Raised when task field validation fails."""
    pass
```

---

## Validation Rules

### Creation Validation

When creating a new Task:

1. **ID Validation**:
   - Must be positive integer (>= 1)
   - Checked by service layer (auto-generated)
   - Model validates type and range

2. **Title Validation**:
   - Cannot be None, empty, or whitespace-only
   - Must be string type
   - Normalized (trim + collapse spaces)

3. **Description Validation**:
   - None ‚Üí "" conversion
   - Must be string type after conversion
   - Empty string allowed

4. **Completed Validation**:
   - Must be strict boolean type
   - No truthiness coercion (1 ‚â† True, "true" rejected)

### Update Validation

When updating a Task:

1. **ID**: Cannot be updated (immutable)
2. **Title**: Same validation as creation
3. **Description**: Same validation as creation
4. **Completed**: Same validation as creation

---

## State Transitions

### Task Lifecycle

```
[Created] ‚îÄ‚îÄ‚Üí [Incomplete] ‚îÄ‚îÄ‚Üí [Complete]
               ‚Üë                   ‚îÇ
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  (can toggle)

[Any State] ‚îÄ‚îÄ‚Üí [Deleted]
                 (permanent, ID never reused)
```

**States**:
- **Created**: Task just instantiated (always starts as Incomplete)
- **Incomplete**: completed = False (default)
- **Complete**: completed = True
- **Deleted**: Removed from storage (ID persists in counter)

**Transitions**:
- Creation ‚Üí Incomplete (automatic, default completed=False)
- Incomplete ‚Üî Complete (via toggle_completion)
- Any State ‚Üí Deleted (via delete_task, irreversible)

---

## Data Invariants

### Guarantees

1. **ID Uniqueness**: Every task has a unique ID within the session
2. **ID Immutability**: ID never changes after task creation
3. **ID Non-Reuse**: Deleted task IDs are never assigned to new tasks
4. **Type Safety**: All fields maintain declared types after validation
5. **Title Non-Empty**: Title is never empty or whitespace-only after validation
6. **Description String**: Description is always a string (None converted to "")
7. **Boolean Strictness**: completed is always exactly True or False

### Constraints

1. **No Relationships**: Tasks are independent (no parent/child, no dependencies)
2. **No History**: No audit trail or version tracking (Phase I)
3. **No Metadata**: No created_at, updated_at, created_by fields (Phase I)
4. **No Phase II Fields**: No priority or tags
5. **No Phase III Fields**: No due_date or recurring_rule

---

## Data Access Patterns

### Primary Access Patterns

1. **Create Task**:
   - Generate unique ID
   - Validate all fields
   - Store in dict by ID
   - Return Task instance

2. **Read Task by ID**:
   - Lookup in dict by ID
   - Raise TaskNotFoundError if missing
   - Return Task instance

3. **Read All Tasks**:
   - Retrieve all tasks from dict
   - Sort by ID ascending
   - Return list of Task instances

4. **Update Task Fields**:
   - Lookup task by ID
   - Create new Task with updated fields
   - Validate new field values
   - Replace in dict
   - Return updated Task

5. **Toggle Completion**:
   - Lookup task by ID
   - Create new Task with toggled completed value
   - Replace in dict
   - Return updated Task

6. **Delete Task**:
   - Lookup task by ID
   - Remove from dict
   - ID remains in ID generator (not reused)

### Performance Characteristics

- Create: O(1) - dict insertion
- Read by ID: O(1) - dict lookup
- Read All: O(n log n) - iterate dict + sort
- Update: O(1) - dict lookup + replacement
- Delete: O(1) - dict removal

---

## Example Data

### Sample Tasks

```python
# Task 1: Incomplete task with description
Task(
    id=1,
    title="Buy groceries",
    description="Milk, eggs, bread",
    completed=False
)

# Task 2: Complete task without description
Task(
    id=2,
    title="Write report",
    description="",
    completed=True
)

# Task 3: Incomplete task with unicode
Task(
    id=3,
    title="Plan vacation ‚úàÔ∏è",
    description="Research destinations üèñÔ∏è",
    completed=False
)

# Task 4: Task with special characters
Task(
    id=4,
    title='Meeting about "Project X"',
    description="Discuss Q4 roadmap\nPrepare slides",
    completed=False
)
```

### Invalid Task Examples

```python
# Invalid: Empty title
Task(id=1, title="", description="")
# Raises: ValidationError("Title is required and cannot be empty")

# Invalid: Whitespace-only title
Task(id=2, title="   ", description="")
# Raises: ValidationError("Title is required and cannot be empty")

# Invalid: Non-boolean completed
Task(id=3, title="Task", completed=1)
# Raises: ValidationError("Completed status must be a boolean (true or false)")

# Invalid: Negative ID
Task(id=-1, title="Task", description="")
# Raises: ValidationError("ID must be a positive integer")
```

---

## Storage Schema

### In-Memory Storage Structure

```python
# TaskService internal storage
{
    1: Task(id=1, title="Buy groceries", description="Milk, eggs", completed=False),
    2: Task(id=2, title="Write report", description="", completed=True),
    3: Task(id=3, title="Plan vacation", description="", completed=False)
}
```

**Key**: Task ID (int)
**Value**: Task instance

**Properties**:
- O(1) lookup by ID
- Maintains insertion order (Python 3.7+)
- Easy iteration for list command
- Simple to clear for new session

---

## Future Extensibility

### Phase II Additions (Not Implemented in Phase I)

```python
# Phase II fields (DO NOT implement in Phase I)
@dataclass
class Task:
    id: int
    title: str
    description: str = ""
    completed: bool = False
    priority: Optional[str] = None  # Phase II: "low" | "medium" | "high"
    tags: Optional[list[str]] = None  # Phase II: ["work", "urgent"]
```

### Phase III Additions (Not Implemented in Phase I/II)

```python
# Phase III fields (DO NOT implement in Phase I/II)
@dataclass
class Task:
    id: int
    title: str
    description: str = ""
    completed: bool = False
    priority: Optional[str] = None
    tags: Optional[list[str]] = None
    due_date: Optional[datetime] = None  # Phase III
    recurring_rule: Optional[str] = None  # Phase III: "daily" | "weekly"
```

**Constitution Enforcement**: Phase I implementation MUST NOT include priority, tags, due_date, or recurring_rule fields.

---

## Summary

- **Single Entity**: Task with 4 fields
- **Strong Validation**: All constraints enforced via `__post_init__`
- **Type Safety**: Full type hints with strict type checking
- **Simple Storage**: In-memory dict for O(1) access
- **No Relationships**: Flat, independent tasks
- **Phase I Compliant**: Only approved fields, no Phase II/III features
- **Extensibility**: Clear path for Phase II/III field additions
